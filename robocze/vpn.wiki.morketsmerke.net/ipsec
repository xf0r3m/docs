<strong>IPSec</strong> (ang. <em>IP Security</em> - bezpieczeństwo w IP) - to zestaw protokołów kryptograficznych opracowanych przez grupę IETF w odpowiedzi na za potrzebowanie rynku IT na bezpieczną komunikację sieciową przez internet.

Podstawowym założeniem przy projektowaniu IPSec było zapewnienie integralności i poufności przesyłanych danych niezależnie od używanych protokołów warstw wyższy modelu OSI (TCP/UDP itd.). Zapewnienie integralności przesyłanych danych, czyli możliwości wykrycia tego, czy pakiet nie został zmodyfikowany, osiągnięto po przez stosowanie skrótów kryptograficznych zamiast zwykłych sum kontrolnych w protokole IP (które można przeliczyć po modyfikacji pakietu). Poufność z kolei, zapewnia szyfrowanie danych kluczem symetrycznym (np. DES, 3DES, AES). Przy czym IPSec nie narzuca wyboru algorytmu szyfrowania, dzięki czemu protokół jest bardzo uniwersalny. W razie złamania w przyszłości, któregoś z obecnie używanych algorytmów jest jego zamiana przez przebudowy całego protokołu.

IPSec może być wykorzystywany w jednym z dwóch trybów. Pierwszy to tryb transportowy, w którym nagłówek IPSec wstawiany jest pomiędzy oryginalny nagłówek IP a nagłówek warstwy transportowej. Tryb transportowy używany jest pomiędzy dwoma hostami komunikującymi się przez IPSec. Drugim rodzajem połączeń IPSec jest tryb tunelowy w którym cały pierwotny pakiet IP enkapsulowany jest wewnątrz nagłówka IPSec. Tryb tunelowy na ogół wykorzystywany jest do łączenia całych sieci korporacyjnych z wykorzystaniem bram VPN. W tym przypadku komputery w sieciach wewnętrznych "nie wiedzą" w ogóle o fakcie, że pakiety po opuszczeniu routera opakowane są w nagłówki IPSec i w formie zaszyfrowanej wędrują przez internet. Brama VPN po drugiej stronie wyodrębnia pierwotne pakiety IP i przesyła do właściwego host wewnątrz sieci wewnętrznej. Warto zauważyć, że w trybie tunelowania w razie ewentualnego podsłuchu transmisji osoba podsłuchująca nie jest wstanie dowiedzieć się nawet, pomiędzy jakimi hostami wymienia są dane. Adresy źródłowy i docelowy nagłówka IPSec zawierają adresy bram VPN, a nie rzeczywistych hostów.

Dwa podstawowe protokoły wchodzące w skład IPSec to AH i ESP. Protokół AH (ang. <em>Authentication Header</em>) zapewnia integralność danych, ale nie zapewnia poufności. Nie jest możliwy spoofing czy inna modyfikacja pakietu ponieważ suma kontrolna została zabezpieczona kryptograficznie (funkcją skrótu - metoda HMAC) przy użyciu tajnego klucza znanego tylko nadawcy i odbiorcy.

Przed właściwą komunikacją zabezpieczoną protokołem AH (lub ESP) strony nawiązują logiczne połączenie w warstwie sieci, tworząc tzw. skojarzenie bezpieczeństwa SA (ang. <em>Security Association</em>) . Owo skojarzenie SA charakteryzują następujące elementy:
* idetyfikator używanego protokołu bezpieczeństwa (AH lub ESP),
* źródłowy i docelowy adres IP połączenia,
* 32-bitowa liczba będąca identyfikacją połączenia, określana mianem SPI (ang. <em>Security Parameter Index</em>).

Skojarzenie bezpieczeństwa SA jest jednokierunkowe, dlatego do bezpiecznej komunikacji dwustronnej potrzebne są dwa niezależne kanały SA, po jednym w każdnym kierunku. Zauważ jednak że w pewnych okolicznościach wystarczy zabezpieczenie tylko jednej strony (np. odpowiedzi serwera DNS), stąd koncepcja "jednokierunkowości" połączeń jest uzasadniona.

Z protokołem AH związane jest także pojęcie SN - <em>serial number</em>, którego celem jest zabezpieczenie transmisji przez atakiem polegającym na wielokrotnym przesyłaniu tego samego pakietu do odbiorcy przez hosta , który podsłuchał pakiet (ang. <em>reply attack</em>). Na początku komunikacji strony ustawiają wartość SN na <em>0</em>, a następnie inkrementują ją wraz z każdym wysłanym pakietem. Dzięki temu odbiorca może wykryć, że odebrany właśnie pakiet to kopia już wcześniej otrzymanego. 

Protokół ESP (ang. <em>Encapsulated Security Payload</em>) pierwotnie zapewniał wyłącznie szyfrowanie transmisji przy użyciu któregoś z szyfrów blokowych (DES, 3DES, AES). Dlatego dla zapewnienia integralności i poufności danych wykorzystywano oba protokoły - AH i ESP - jednocześnie. 

Obecnie jednak ESP zapewnia także sprawdzenia integralności danych (zasada działania bardzo podobna do AH - suma kontrolna zabezpieczona kryptograficznie), dlatego protokół AH wychodzi z użycia. W przypadku gdy szyfrowanie transmisji nie jest konieczne, w ESP istnieje możliwość zastosowania algorytmu NULL zamiast któregoś z algorytmów kryptograficznych. Istotną różnicą między protokołami ESP i AH jest fakt, że w przypadku ESP ochrona integralności nie obejmuje nagłówka IP (tego widzianego przez pośredniczące routery), dzięki czemu protokół IPSec/ESP może przechodzić przez połączenia za NAT-em.

Za automatyczną negocjację parametrów połączenia tj. uwierzytelnianie, ustalenie relacji SA oraz późniejsze uzgadniania kluczy kryptograficznych odpowiada osobny protokół wymiany kluczy - IKE (ang <em>Internet Key Exchange</em>), także wchodzący w skład IPSec . Przy czym samo uwierzytelnienie może być przeprowadzone różnymi metodami - współdzielony klucz, podpisy RSA, certyfikaty X.509 lub kerberos.

Protokół IKE działa w dwóch fazach. Pierwsza faza - ISAKMP (ang. <em>Internet Security Association and Key Management Protocol</em>), odpowiada za przeprowadzenie uwierzytelnienia , utworzenie kanału ISAKMP SA i zarządzanie nim. Druga faza - Oakley, odpowiada za uzgadnianie klucz (wg. algorytmu DH) i związków SA w trakcie połączenia.

ISAKMP może zostać przeprowadzona w trybie głównym (ang. <em>main mode</em>) lub w tzw. trybie agresywnym (ang. <em>aggresive mode</em>). W trybie głównym wymieniane są 3 dwukierunkowe komunikaty (komunikat-odpowiedź - razem 6). W trybie agresywnym natomiast przesyłane są jedynie 3 komunikaty. Tryb agresywny jest szybszy, natomiast ma pewną słabość, którą w pewnych okolicznościach można wykorzystać do odgadnięcia klucz PSK. Otóż w trybie agresywnym cześć informacji przesyłana jest przez ustanowieniem bezpiecznego kanału. W przypadku uwierzytelnienia przez PSK i użycia trybu agresywnego osoba podsłuchująca transmisję jest w stanie podejrzeć hash współdzielonego klucza, a następnie próbować odnaleźć klucz metodą słownikową. Znając PSK, atakujący może zestawić tunel VPN, podszywając się pod pracownika firmy, którego połączenie wcześniej podsłuchał. Oprócz rozkodowania PSK możliwy jest w tym przypadku atak typu man-in-the-middle. 

Z powyższego wynika, że powinniśmy unikać trybu agresywnego w połączeniu z uwierzytelnianiem PSK. Ogólnie nie powinniśmy używać uwierzytelnienia przez PSK dla tuneli zdalnych pracowników, gdzie IP drugiej strony tunelu nie jest znane (możliwość siłowego odgadnięcia hasła).

Faza druga (Oakley) przebiega zawsze w trybie <em>quick mode</em>. Jako że jest to faza druga, nie przeprowadza ona własnych metod uwierzytelnienia i umożliwia szybkie (stąd nazwa) zestawienie relacji IPSec SA.

Z drugą fazą związane jest także opcjonalne pojęcie PFS (ang. <em>Perfect Forward Secrecy</em>) - poufność doskonała. Przez pojęcie to rozumie się sposób wymiany kluczy sesyjnych w trakcie połączenia IPSec. Załączenie PFS, zapewnia że materiał klucza głównego może być używany do wygenerowania tylko jednego klucza sesji. Przed utworzeniem nowego klucza sesji jest przeprowadzana wymiana kluczy (algorytm Diffiego-Hellmana) w celu wygenerowania nowego materiału klucza głównego. Dzięki zastosowaniu PFS uzyskanie przez atakującego pojedynczego klucza pozwala mu na odczytanie tylko wiadomości zaszyfrowanych tym kluczem. Niestety, załączenie PFS wiąże się ze spadkiem wydajności (i wzrostem obciążenia procesora). Dodatkowo nie wszystkie implementacje obsługują tę właściwość.

Każda ze stron przechowuje informacje o nawiązanych skojarzeniach SA w tzw. bazie SAD (ang. <em>Security Association Database</em>).

Do terminologi związanej z IPSec musimy jeszcze dołożyć pojęcia SPD - <em>Security Policy Database</em>. SPD to baza odpowiadająca przyjętej polityce bezpieczeństwa. Baza SPD jest używana dla pakietów wychodzących. System sprawdza przez wysłaniem, czy dla określonego hosta (sieci) docelowego istnieje jakiś wpis określający, czy protokół IPSec ma zostać użyty. Jeżeli tak, przegląda jest baza SAD w poszukiwaniu skojarzenia SA odpowiedzialnego za komunikacje w określonym hostem docelowym.

== IPSec a translacja adresów (maskarada) ==

NAT (ang. <em>Network Address Transtalation</em>) to translacja adresów popularnie zwana maskaradą. Najkrócej mówiąc polega ona ukrywaniu hosta wewnętrznego poprzez zamianę adresu źródłowego w nagłówku pakietu IP - na adres routera. W tym przypadku NAT (a w zasadzie PAT - <em>Port Address Translation</em>) stara się zachować port źródłowy, który został wybrany przez hosta źródłowego; dopiero gdy ten port jest zajęty przez inne połączenie NAT, zostanie zamieniony na inny. Router pełniący rolę NAT-a przechowuje wszystkie bieżące połączenia w specjalnej tabeli NAT, dzięki czemu wie, do którego hosta przekierować ma odpowiedzi przychodzące na dany port. Mechanizm ten doskonale sprawdza się w przypadku połączeń TCP/UDP, gdzie bez problemowo możemy przekierować połączenie przychodzące na port 1234 do portu 5673 komputera wewnątrz sieci (za maskaradą).

W przypadku połączeń IPSec sprawa nie wygląda tak prosto z dwóch powodów.

Po pierwsze w przypadku protokołu AH nie jest możliwa zmiana adresu źródłowego w nagłówku pakietu IP, gdyż cały nagłówek zabezpieczony jest przez zmianą - do nagłówka dodawany jest skrót kryptograficzny utworzony z sumy kontrolnej pakietu oraz tajnego hasła. Jakakolwiek modyfikacja nagłówka pakietu uznana będzie za naruszenie integralności danych (router, nie znając hasła nie będzie w stanie wygenerować odpowiedniego skrótu). Na to nic nie poradzimy. Dla protokołu AH nie jest możliwa translacja adresów.

W przypadku protokołu ESP sprawa wygląda lepiej, gdyż, ochronie integralności nie podlega "zewnętrzny" nagłówek IP, tak więc możliwa jest zamiana źródłowego adresu I. Pojawia się jednak niestety problem z wieloma klienta znajdującymi się za tym samym routerem (maskaradą). Protokół ESP nie wykorzystuje portów, jak ma to miejsce w protokołach TCP i UDP, dlatego nie można w prosty sposób odróżnić połączeń IPSec inicjowanie z różnych hostów wewnątrz sieci.

Rozwiązanie powyższego problemu jest tzw. NAT-Traversal. Mechanizm ten polega na enkapsulacji protokołu ESP wewnątrz połączenia UDP (najczęściej port 4500)

Jak widać działanie protokołu IPSec (zespołu protokołów) jest dość złożone. Przedstawiono tutaj najistotniejsze elementy, tak aby poza posiadaniem wiedzy praktycznej, posiadać wiedzę teoretyczną, która to pomoże zrozumieć nam gdzie zrobiliśmy błąd, jeśli coś nie zadziała lub nagle przestanie. Na szczęście konfiguracja połączenia IPSec z automatyczną wymianą kluczy (IKE) nie jest wcale taka trudna, co zostanie zobrazowane.

== Najważniejsze pojęcia związane z IPSec ==

* <strong>Protokół ESP (ang. <em>Encapsulated Security Payload</em>)</strong> - podstawowy składnik IPSec. Pierwotnie zapewniał wyłączenie poufność, tj. szyfrowanie transmisji przy użyciu któregoś z blokowych (DES, 3DES, AES). Obecnie jednak ESP zapewnia także sprawdzenie integralności danych. ESP w przeciwieństwie do AH nie zabezpiecza nagłówka IP pierwotnego pakietu.
* <strong>Protokół AH (ang. Authentication Header)</strong> - jeden z protokołów wchodzących w skład IPSec. Jego zadaniem jest zapewnienie integralności przesyłanych danych (funkcja skrótu HMAC). Protokół AH nie zapewnia poufności. Wychodzi on obecnie z użycia, ponieważ ESP zapewnia tę samą funkcjonalność oraz szyfrowanie.
* <strong>Protokół ISAKMP (ang. <em>Internet Security Association and Key Management Protocol</em>)</strong> - odpowiada za negocjacje parametrów IPSec, przeprowadzenie uwierzytelnienia, tworzenia kanału SA i zarządzanie nim. Do działania wykorzystuje port 500 UDP.
* <strong>Związek SA (ang. <em>Security Association</em>) </strong>- inaczej relacja SA, jednokierunkowy, logiczny kanał komunikacyjny zestawiany w komunikacji IPSec. Do dwustronnej komunikacji IPSec potrzebne są dwa kanały SA. Skojarzenie SA identyfikowane jest przez 32-bitową liczbę zwaną SPI (ang. <em>Security Parametr Index</em>).
* <strong>SPI (ang. <em>Security Parametr Index</em>)</strong> - 32-bitowa liczba, będąca identyfikatorem skojarzenia SA w komunikacji IPSec.
* <strong>Baza SAD</strong> - każda ze stron tunelu IPSec informacje o nawiązanych relacjach SA w tzw. bazie SAD.
* <strong>DH (<em>Diffie-Hellman</em>) </strong>- algorytm uzgadniania klucz, w którym dwie strony na podstawie wymienionych liczb uzgadniają liczbę wynikową - klucz. Osoba podsłuchująca transmisje nie jest w stanie na podstawie tego co usłyszała, wyliczyć klucza.
* <strong>Grupa DH</strong> - informacje mówiąca o wielkości liczb używanych w obliczeniach w algorytmie Diffiego-Hellmana. DH1:768bitów, DH2:1024bity, DH5:1536 bitów. Grupa pierwsza obecnie uważna jest za słabą.
* <strong>Hash</strong> -  inaczej funkcja skrótu. Dla dowolnie długiego ciągu wejściowego wyliczany jest skrót o stałej długości. Do najczęściej używanych funkcji należą MD5 i SHA-1, SHA-2. Funkcje skrótu wykorzystywane są do tworzenia sygnatur (np. cyfrowe zabezpieczenie sumy kontrolnej pakietu lub pliku).
* <strong>HMAC (ang. <em>keyed-Hash Message Authentication Code</em>)</strong> - zabezpieczona hasłem funkcja, skrótu. Dzięki temu oprócz ochrony integralności zapewniona jest też autentyczność pochodzenia. Osoba zabezpieczająca dokument podaje hasło i na podstawie hasła i dokumentu tworzony jest skrót. Osoba sprawdzająca znając hasło, jest w stanie potwierdzić autentyczność.
* <strong>SHA (SHA-1, SHA-2)</strong> - funkcje skrótu służące to tworzenia sygnatur.
* <strong>MD5</strong> - funkcja skrótu, w wyniku której powstaje 128-bitowy hash.
* <strong>DES (ang. <em>Data Encryption Standard</em>)</strong> - algorytm szyfrowania symetrycznego. Ze względu ma słabość klucza - 56 bitów - obecnie wyszedł z użycia. Jego następcy to 3DES oraz AES.
* <strong>AES (ang. <em>Adavanced Encryption Standard</em>) </strong> - silny szyfr blokowy, możliwe długości klucza to 128, 192, 256 bitów. Powstał w wyniku konkursu na następcę DES. Obecnie często wykorzystywany w kryptografii. m.in w IPSec.
* <strong>RSA</strong> - jeden z algorytmów kryptografii asymetrycznej, stosowany m.in. w podpisach cyfrowych.
* <strong>Transform-set</strong> - w terminologii Cisco zbiór parametrów związanych z połączeniem IPSec. Do parametrów metrów tych należą m. in.: rozdzaj protokołu IPSec (ESP, AH) używany protokół szyfrowania (3DES, AES), używana funkcja skrótu (SHA, MD5) itp.
* <strong>Crypto-map</strong> - w terminologii Cisco to ustawienie, które wiąże niejako wszystkie parametry tunelu w całość. Zawiera nazwę transform-seta (parametry IPSec), adres IP zdalnego routera oraz numer listy dostępu kontrolującej, jaki ruch zostanie przesłany tunelem VPN.

